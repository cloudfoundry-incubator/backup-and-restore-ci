---
maru-bosh-env: &maru-bosh-env
  BOSH_ENVIRONMENT: "((maru-bosh-director-url))"
  BOSH_CLIENT: "((maru-bosh-director-username))"
  BOSH_CLIENT_SECRET: "((maru-bosh-director-password))"
  BOSH_CA_CERT: "((maru-bosh-director-ca-cert))"
  BOSH_GW_HOST: "((maru-jumpbox-url)):22"
  BOSH_GW_USER: jumpbox
  BOSH_GW_PRIVATE_KEY: "((maru-jumpbox-ssh-key))"

maru-lite-bosh-env: &maru-lite-bosh-env
  BOSH_ENVIRONMENT: "((maru-lite-bosh-director-url))"
  BOSH_CLIENT: "((maru-lite-bosh-director-username))"
  BOSH_CLIENT_SECRET: "((maru-lite-bosh-director-password))"
  BOSH_CA_CERT: "((maru-lite-bosh-director-ca-cert))"
  BOSH_GW_USER: jumpbox
  BOSH_GW_HOST: "((maru-lite-jumpbox-address)):22"
  BOSH_GW_PRIVATE_KEY: "((maru-lite-jumpbox-ssh-key))"

maru-lite-bosh-team-creds: &maru-lite-bosh-team-creds
  BOSH_ENVIRONMENT: "((maru-lite-bosh-director-url))"
  BOSH_CLIENT: "((bosh-team-admin))"
  BOSH_CLIENT_SECRET: "((bosh-team-admin-secret))"
  BOSH_CA_CERT: "((maru-lite-bosh-director-ca-cert))"
  BOSH_GW_USER: jumpbox
  BOSH_GW_HOST: "((maru-lite-jumpbox-address)):22"
  BOSH_GW_PRIVATE_KEY: "((maru-lite-jumpbox-ssh-key))"

test-bosh-director-ip: &test-bosh-director-ip 10.0.1.8
test-bosh-director-deployment: &test-bosh-director-deployment test-bosh-director

groups:
- name: BUILD
  jobs:
  - upload-deployment-test-releases
  - unit
  - deploy-system-deployment-bosh-all-proxy
  - deploy-system-all-deployments
  - deploy-system-windows
  - deploy-fake-director
  - system-test-deployment
  - system-test-bosh-all-proxy
  - system-test-director
  - system-test-windows
  - system-test-all-deployments
  - delete-system-director
  - delete-system-deployment-bosh-all-proxy
  - delete-system-windows
  - delete-system-all-deployments
  - build-rc
  - install-optional-components-on-pas
  - run-p-drats-on-pas

- name: SHIPIT
  jobs:
  - build-and-publish-final
  - update-homebrew-formula

resource_types:
- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final

- name: bosh-deployment-resource
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource

resources:
- name: bbr-director-test-releases
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/bosh-backup-and-restore-test-releases.git
    private_key: ((git-private-key))
    branch: master
    paths:
    - test-bosh-backup-and-restore-release

- name: bbr-deployment-test-releases
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/bosh-backup-and-restore-test-releases.git
    private_key: ((git-private-key))
    branch: master
    paths:
    - redis-test-release
    - lock-ordering-release
    - many-bbr-jobs-release

- name: bosh-backup-and-restore
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/bosh-backup-and-restore.git
    private_key: ((git-private-key))
    branch: master
    disable_git_lfs: true
    ignore_paths:
    - ci

- name: bosh-backup-and-restore-meta
  type: git
  source:
    uri: git@github.com:pivotal-cf/bosh-backup-and-restore-meta.git
    private_key: ((git-private-key))
    git_crypt_key: ((git-crypt-key))
    branch: master

- name: release-trigger
  type: git
  source:
    uri: git@github.com:pivotal-cf/bosh-backup-and-restore-meta.git
    private_key: ((git-private-key))
    git_crypt_key: ((git-crypt-key))
    branch: master
    paths:
    - bbr-current-release/version

- name: backup-and-restore-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry-incubator/backup-and-restore-ci.git
    private_key: ((git-private-key))
    branch: master

- name: bbr-pivnet
  type: pivnet
  source:
    api_token: ((pivnet-api-token))
    product_slug: p-bosh-backup-and-restore
    access_key_id: ((pivnet-aws-access-key-id))
    secret_access_key: ((pivnet-aws-secret-access-key))

- name: homebrew-tap
  type: git
  source:
    uri: git@github.com:cloudfoundry/homebrew-tap.git
    branch: master
    private_key: ((homebrew-git-private-key))

- name: rc
  type: s3
  source:
    bucket: bosh-backup-and-restore-builds
    region_name: eu-west-1
    regexp: bbr-(.*)\.tar
    access_key_id: ((aws-access-key-id))
    secret_access_key: ((aws-secret-access-key))

- name: version
  type: semver
  source:
    bucket: bosh-backup-and-restore-builds
    region_name: eu-west-1
    key: current-version
    access_key_id: ((aws-access-key-id))
    secret_access_key: ((aws-secret-access-key))

- name: bbr-release
  type: github-release
  source:
    user: cloudfoundry-incubator
    repository: bosh-backup-and-restore
    access_token: ((github-access-token))
    drafts: true

- name: bbr-final-release
  type: github-release
  source:
    user: cloudfoundry-incubator
    repository: bosh-backup-and-restore
    access_token: ((github-access-token))

- name: pivotal-disaster-recovery-acceptance-tests
  type: git
  source:
    uri: git@github.com:pivotal-cf/pivotal-disaster-recovery-acceptance-tests.git
    private_key: ((git-private-key))
    branch: master

- name: windows-vm-deployment
  type: bosh-deployment-resource
  source:
    deployment: redis-windows-ci
    skip_check: true

- name: many-bbr-scripts-deployment
  type: bosh-deployment-resource
  source:
    deployment: many-bbr-scripts
    skip_check: true

- name: jumpbox-windows-deployment
  type: bosh-deployment-resource
  source:
    deployment: jumpbox-windows-ci
    skip_check: true

- name: all-deployments-redis-1-deployment
  type: bosh-deployment-resource
  source:
    deployment: redis-1
    skip_check: true

- name: all-deployments-redis-2-deployment
  type: bosh-deployment-resource
  source:
    deployment: redis-2
    skip_check: true

- name: all-deployments-redis-3-deployment
  type: bosh-deployment-resource
  source:
    deployment: redis-3
    skip_check: true

- name: windows-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-windows2016-go_agent

- name: xenial-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-ubuntu-xenial-go_agent

- name: bosh-deployment
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-deployment.git

- name: test-bosh-director-deployment
  type: bosh-deployment-resource
  source:
    deployment: *test-bosh-director-deployment
    skip_check: true

jobs:
- name: deploy-fake-director
  serial: true
  serial_groups: [system-test-director]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [unit]
      trigger: true
    - get: bosh-deployment
    - get: bosh-backup-and-restore-meta
    - get: bbr-director-test-releases
      trigger: true
    - get: xenial-stemcell
    - get: backup-and-restore-ci
  - task: generate-bosh-deployment-source-file
    file: backup-and-restore-ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      BBL_STATE: maru
  - put: test-bosh-director-deployment
    params:
      manifest: bosh-backup-and-restore/fixtures/fake-director.yml
      stemcells:
      - xenial-stemcell/*.tgz
      source_file: source-file/source-file.yml
      vars:
        deployment-name: test-bosh-director
        jumpbox-public-key: ((test-bosh-director-public-key))
        test_release_path: /tmp/build/put/bbr-director-test-releases/test-bosh-backup-and-restore-release

- name: upload-deployment-test-releases
  serial: true
  plan:
  - in_parallel:
    - get: bbr-deployment-test-releases
      trigger: true
    - get: backup-and-restore-ci
    - get: bosh-backup-and-restore-meta
  - in_parallel:
    - task: upload-redis-test-release-maru-lite
      file: backup-and-restore-ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: redis-test-release
        <<: *maru-lite-bosh-env
    - task: upload-many-bbr-jobs-release-lite-bosh-uaa
      file: backup-and-restore-ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: many-bbr-jobs-release
        <<: *maru-lite-bosh-env
    - task: upload-many-bbr-jobs-release-maru
      file: backup-and-restore-ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: many-bbr-jobs-release
        <<: *maru-bosh-env
    - task: upload-redis-test-release-maru-bosh
      file: backup-and-restore-ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: redis-test-release
        <<: *maru-bosh-env
    - task: upload-redis-test-release-lite-bosh-uaa
      file: backup-and-restore-ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: redis-test-release
        <<: *maru-lite-bosh-env
    - task: upload-lock-ordering-release-lite-bosh-uaa
      file: backup-and-restore-ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: lock-ordering-release
        <<: *maru-lite-bosh-env

- name: unit
  serial: true
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      trigger: true
      params:
        submodules: none
        disable_git_lfs: true
    - get: backup-and-restore-ci
  - task: unit
    file: backup-and-restore-ci/tasks/bbr-unit/task.yml
    privileged: true
    params:
      DOCKER_HOST: "tcp://10.0.255.1:4243"
      GITHUB_SSH_KEY: "((github-ssh-key))"

- name: deploy-system-deployment-bosh-all-proxy
  serial: true
  serial_groups: [system-test-bosh-all-proxy]
  plan:
  - in_parallel:
    - get: xenial-stemcell
    - get: bosh-backup-and-restore
      passed: [unit]
      trigger: true
    - get: bbr-deployment-test-releases
      passed: [upload-deployment-test-releases]
      trigger: true
    - get: backup-and-restore-ci
    - get: bosh-backup-and-restore-meta
  - task: generate-bosh-deployment-source-file
    file: backup-and-restore-ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      BBL_STATE: maru
  - put: many-bbr-scripts-deployment
    params:
      manifest: bosh-backup-and-restore/fixtures/many-bbr-scripts.yml
      stemcells:
        - xenial-stemcell/*.tgz
      source_file: source-file/source-file.yml

- name: deploy-system-all-deployments
  serial: true
  serial_groups: [system-test-all-deployments]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [unit]
      trigger: true
    - get: bbr-deployment-test-releases
      passed: [upload-deployment-test-releases]
      trigger: true
    - get: backup-and-restore-ci
  - task: create-bosh-team-admin-maru-lite
    file: backup-and-restore-ci/tasks/bbr-create-bosh-team-admin/task.yml
    privileged: true
    params:
      BOSH_ENVIRONMENT: 10.0.0.6
      UAA_CLIENT: ((maru-lite-uaa-admin-client))
      UAA_CLIENT_SECRET: ((maru-lite-uaa-admin-client-secret))
      BOSH_TEAM_CLIENT: ((bosh-team-admin))
      BOSH_TEAM_CLIENT_SECRET: ((bosh-team-admin-secret))
      JUMPBOX_HOST: ((maru-lite-jumpbox-address))
      JUMPBOX_USER: jumpbox
      JUMPBOX_PRIVATE_KEY: ((maru-lite-jumpbox-ssh-key))
  - in_parallel:
    - task: deploy-bosh-team-redis-1
      file: backup-and-restore-ci/tasks/bbr-deploy-bosh-team/task.yml
      params:
        <<: *maru-lite-bosh-team-creds
        DEPLOYMENT_NAME: redis-1
    - task: deploy-bosh-team-redis-2
      file: backup-and-restore-ci/tasks/bbr-deploy-bosh-team/task.yml
      params:
        <<: *maru-lite-bosh-team-creds
        DEPLOYMENT_NAME: redis-2
    - task: deploy-bosh-team-redis-3
      file: backup-and-restore-ci/tasks/bbr-deploy-bosh-team/task.yml
      params:
        <<: *maru-lite-bosh-team-creds
        DEPLOYMENT_NAME: redis-3

- name: deploy-system-windows
  serial: true
  serial_groups: [system-test-windows]
  plan:
  - in_parallel:
    - get: windows-stemcell
    - get: xenial-stemcell
    - get: bosh-backup-and-restore
      passed: [unit]
      trigger: true
    - get: bbr-deployment-test-releases
      passed: [upload-deployment-test-releases]
      trigger: true
    - get: backup-and-restore-ci
    - get: bosh-backup-and-restore-meta
  - task: generate-bosh-deployment-source-file
    file: backup-and-restore-ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      BBL_STATE: maru
  - in_parallel:
    - put: windows-vm-deployment
      params:
        manifest: bosh-backup-and-restore/fixtures/redis-windows-ci.yml
        stemcells:
        - windows-stemcell/*.tgz
        - xenial-stemcell/*.tgz
        source_file: source-file/source-file.yml
    - put: jumpbox-windows-deployment
      params:
        manifest: bosh-backup-and-restore/fixtures/jumpbox-windows-ci.yml
        stemcells:
        - xenial-stemcell/*.tgz
        source_file: source-file/source-file.yml

- name: system-test-deployment
  serial: true
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [unit]
      trigger: true
    - get: bosh-backup-and-restore-meta
    - get: backup-and-restore-ci
    - get: bbr-deployment-test-releases
      passed: [upload-deployment-test-releases]
      trigger: true
  - task: system-deployment-with-uaa
    file: backup-and-restore-ci/tasks/bbr-system-deployment/task.yml
    params:
      <<: *maru-lite-bosh-env

- name: system-test-bosh-all-proxy
  serial: true
  serial_groups: [system-test-bosh-all-proxy]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [deploy-system-deployment-bosh-all-proxy]
      trigger: true
    - get: bosh-backup-and-restore-meta
    - get: backup-and-restore-ci
    - get: bbr-deployment-test-releases
      passed: [deploy-system-deployment-bosh-all-proxy]
      trigger: true
  - task: system-test-bosh-all-proxy
    file: backup-and-restore-ci/tasks/bbr-system-bosh-all-proxy/task.yml
    params:
      <<: *maru-bosh-env
      DIRECTOR_SSH_KEY: ((maru-director-ssh-key))
      DIRECTOR_ADDRESS: 10.0.0.6

- name: system-test-director
  serial: true
  serial_groups: [system-test-director]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [deploy-fake-director]
      trigger: true
    - get: bosh-backup-and-restore-meta
    - get: backup-and-restore-ci
    - get: bbr-director-test-releases
      passed: [deploy-fake-director]
      trigger: true
  - task: system-test-director
    file: backup-and-restore-ci/tasks/bbr-system-director/task.yml
    privileged: true
    params:
      JUMPBOX_HOST: "((maru-jumpbox-url)):22"
      JUMPBOX_USER: jumpbox
      JUMPBOX_SSH_KEY: "((maru-jumpbox-ssh-key))"
      CREDHUB_SERVER: "((maru-credhub-server))"
      CREDHUB_CLIENT: "((maru-credhub-client))"
      CREDHUB_SECRET: "((maru-credhub-secret))"
      CREDHUB_CA_CERT: "((maru-credhub-ca_cert))"
      DIRECTOR_HOST: *test-bosh-director-ip
      DIRECTOR_SSH_KEY: ((test-bosh-director-private-key))
      DIRECTOR_SSH_USERNAME: jumpbox
      BOSH_DEPLOYMENT: *test-bosh-director-deployment

- name: system-test-windows
  serial: true
  serial_groups: [system-test-windows]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [deploy-system-windows]
      trigger: true
    - get: bosh-backup-and-restore-meta
    - get: backup-and-restore-ci
    - get: bbr-deployment-test-releases
      passed: [deploy-system-windows]
      trigger: true
  - task: system-test-windows
    file: backup-and-restore-ci/tasks/bbr-system-windows/task.yml
    params:
      <<: *maru-bosh-env

- name: system-test-all-deployments
  serial: true
  serial_groups: [system-test-all-deployments]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [deploy-system-all-deployments]
      trigger: true
    - get: backup-and-restore-ci
    - get: bosh-backup-and-restore-meta
  - task: system-test-all-deployments
    file: backup-and-restore-ci/tasks/bbr-system-all-deployments/task.yml
    params:
      <<: *maru-lite-bosh-team-creds

- name: delete-system-director
  serial: true
  serial_groups: [system-test-director]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [system-test-director]
      trigger: true
    - get: bbr-director-test-releases
      passed: [system-test-director]
      trigger: true
    - get: backup-and-restore-ci
    - get: bosh-backup-and-restore-meta
  - task: generate-bosh-deployment-source-file
    file: backup-and-restore-ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      BBL_STATE: maru
  - put: test-bosh-director-deployment
    params:
      delete:
        enabled: true
      source_file: source-file/source-file.yml

- name: delete-system-all-deployments
  serial: true
  serial_groups: [system-test-all-deployments]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [system-test-all-deployments]
      trigger: true
    - get: backup-and-restore-ci
    - get: bosh-backup-and-restore-meta
  - task: generate-bosh-deployment-source-file
    file: backup-and-restore-ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      BBL_STATE: maru-lite
  - in_parallel:
    - put: all-deployments-redis-1-deployment
      params:
        delete:
          enabled: true
        source_file: source-file/source-file.yml
    - put: all-deployments-redis-2-deployment
      params:
        delete:
          enabled: true
        source_file: source-file/source-file.yml
    - put: all-deployments-redis-3-deployment
      params:
        delete:
          enabled: true
        source_file: source-file/source-file.yml

- name: delete-system-deployment-bosh-all-proxy
  serial: true
  serial_groups: [system-test-bosh-all-proxy]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [system-test-bosh-all-proxy]
      trigger: true
    - get: backup-and-restore-ci
    - get: bosh-backup-and-restore-meta
  - task: generate-bosh-deployment-source-file
    file: backup-and-restore-ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      BBL_STATE: maru
  - put: many-bbr-scripts-deployment
    params:
      delete:
        enabled: true
      source_file: source-file/source-file.yml

- name: delete-system-windows
  serial: true
  serial_groups: [system-test-windows]
  plan:
  - get: bosh-backup-and-restore
    passed: [system-test-windows]
    trigger: true
  - get: backup-and-restore-ci
  - get: bosh-backup-and-restore-meta
  - task: generate-bosh-deployment-source-file
    file: backup-and-restore-ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      BBL_STATE: maru
  - in_parallel:
    - put: windows-vm-deployment
      params:
        delete:
          enabled: true
        source_file: source-file/source-file.yml
    - put: jumpbox-windows-deployment
      params:
        delete:
          enabled: true
        source_file: source-file/source-file.yml

- name: build-rc
  serial_groups: [version]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [system-test-all-deployments, system-test-deployment, system-test-bosh-all-proxy, system-test-director, system-test-windows]
      trigger: true
      params:
        submodules: none
        disable_git_lfs: true
    - get: version
      params: {pre: rc}
    - get: bosh-backup-and-restore-meta
    - get: backup-and-restore-ci
  - task: build
    file: backup-and-restore-ci/tasks/bbr-build/task.yml
  - put: rc
    params: {file: bbr-build/bbr-*.tar}
  - put: version
    params: {file: version/number}

- name: install-optional-components-on-pas
  serial: true
  serial_groups: [p-drats]
  plan:
  - get: pivotal-disaster-recovery-acceptance-tests
  - task: enable-internal-blobstore
    file: pivotal-disaster-recovery-acceptance-tests/ci/enable-internal-blobstore-pas/task.yml
    params:
      OPS_MAN_URL: ((ops-man-url))
      OPS_MAN_USER: ((ops-man-user))
      OPS_MAN_PASS: ((ops-man-pass))
  - task: configure-diego-cells
    file: pivotal-disaster-recovery-acceptance-tests/ci/configure-diego-cells-pas/task.yml
    params:
      OPS_MAN_URL: ((ops-man-url))
      OPS_MAN_USER: ((ops-man-user))
      OPS_MAN_PASS: ((ops-man-pass))
  - task: enable-optional-components
    file: pivotal-disaster-recovery-acceptance-tests/ci/enable-optional-components-pas/task.yml
    privileged: true
    params:
      OPS_MAN_URL: ((ops-man-url))
      OPS_MAN_USER: ((ops-man-user))
      OPS_MAN_PASS: ((ops-man-pass))
      OPS_MAN_VERSION: "2.3"

- name: run-p-drats-on-pas
  serial: true
  serial_groups: [p-drats]
  plan:
  - in_parallel:
    - get: pivotal-disaster-recovery-acceptance-tests
    - get: bosh-backup-and-restore
      passed: [build-rc]
    - get: rc
      passed: [build-rc]
      trigger: true
  - task: acceptance-tests
    privileged: true
    file: pivotal-disaster-recovery-acceptance-tests/ci/p-drats-ops-manager/task.yml
    input_mapping:
      bbr-binary-release: rc
    params:
      DEFAULT_TIMEOUT_MINS: 30
      OPS_MAN_URL: ((ops-man-url))
      OPS_MAN_USER: ((ops-man-user))
      OPS_MAN_PASS: ((ops-man-pass))
      OPS_MAN_SSH_KEY: ((ops-man-ssh-key))
      SKIP_SUITE_NAME: cf-smbbroker

- name: build-and-publish-final
  serial_groups: [version]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore-meta
      resource: release-trigger
      trigger: true
    - get: bosh-backup-and-restore
      passed: [run-p-drats-on-pas]
      params:
        submodules: none
        disable_git_lfs: true
    - get: backup-and-restore-ci
    - get: homebrew-tap
  - task: get-version
    config:
      platform: linux
      image_resource:
        type: docker-image
        source: {repository: pcfplatformrecovery/backup-and-restore}
      inputs:
      - name: bosh-backup-and-restore-meta
      outputs:
      - name: bbr-version
      run:
        path: /bin/bash
        args:
        - -c
        - |-
          set -eux
          cat bosh-backup-and-restore-meta/bbr-current-release/version > bbr-version/number
  - task: build
    file: backup-and-restore-ci/tasks/bbr-build/task.yml
    input_mapping:
      version: bbr-version
  - in_parallel:
    - task: generate-bbr-release-metadata
      file: backup-and-restore-ci/tasks/generate-bbr-release-metadata/task.yml
      input_mapping:
        version-folder: bosh-backup-and-restore-meta
        template-folder: bosh-backup-and-restore-meta
        release: bbr-build
      params:
        TEMPLATE_PATH: templates/release.yml.erb
        VERSION_PATH: bbr-current-release/version
    - task: generate-release-notes
      file: backup-and-restore-ci/tasks/generate-release-notes/task.yml
      input_mapping:
        repo: bosh-backup-and-restore
        template-folder: bosh-backup-and-restore-meta
      params:
        TEMPLATE_PATH: templates/release-notes.md.erb
  - put: bbr-pivnet
    params:
      metadata_file: pivnet-release-with-metadata/release.yml
      s3_filepath_prefix: product-files/bosh-backup-restore
      file_glob: pivnet-release-with-metadata/bbr*
  - put: bbr-release
    params:
      name: bosh-backup-and-restore-meta/bbr-current-release/version
      tag: bosh-backup-and-restore-meta/bbr-current-release/version
      tag_prefix: v
      body: release-notes/release-notes.md
      commitish: bosh-backup-and-restore/.git/refs/heads/master
      globs:
      - github-release-with-metadata/bbr*

- name: update-homebrew-formula
  serial: true
  plan:
  - in_parallel:
    - get: backup-and-restore-ci
    - get: homebrew-tap
    - get: bbr-final-release
      trigger: true
  - task: update-homebrew-formula
    file: backup-and-restore-ci/tasks/bbr-update-homebrew-formula/task.yml
    input_mapping:
      bbr-release: bbr-final-release
  - put: homebrew-tap
    params:
      repository: updated-homebrew-tap
      rebase: true
